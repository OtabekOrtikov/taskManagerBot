from datetime import datetime
import json
from qarz_database.db_utils import get_user_by_id

noactive_btn = {
    "ru": "–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.",
    "uz": "Bu tugma faol emas.",
    "—É–∑": "–ë—É —Ç—É–≥–º–∞ —Ñ–∞–æ–ª —ç–º–∞—Å."
}

missing_field = {
    "ru": {
        "basic": "‚ùóÔ∏è–í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏—Ö.",
        "fullname": "‚ùóÔ∏è–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é.",
        "phone_number": "‚ùóÔ∏è–ù–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
        "birthdate": "üìÖ–ù–∞–ø–∏—à–∏ –≤–∞—à–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–î–î.–ú–ú.–ì–ì–ì–ì'.",
        "rules": "üìö–í—ã –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –∏ –Ω–µ –ø—Ä–∏–Ω—è–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –±–æ—Ç–∞."
    },
    "uz": {
        "basic": "‚ùóÔ∏èSiz ba'zi maydonlarni o'tkazdingiz. Iltimos, ularni to'ldiring.",
        "fullname": "‚ùóÔ∏èIltimos, ism va familiyangizni yozing.",
        "phone_number": "‚ùóÔ∏èIltimos, telefon raqamingizni yozing yoki tugmani bosing.",
        "birthdate": "üìÖSana yozing '–ö–ö.–û–û.–ô–ô–ô–ô' formatida.",
        "rules": "üìöSiz bot qoidalarni o'qimadingiz va qabul qilmadingiz."
    },
    "oz": {
        "basic": "‚ùóÔ∏è–°–∏–∑ –±–∞—ä–∑–∏ –º–∞–π–¥–æ–Ω–ª–∞—Ä–Ω–∏ —û—Ç–∫–∞–∑–¥–∏–Ω–≥–∏–∑. –ò–ª—Ç–∏–º–æ—Å, —É–ª–∞—Ä–Ω–∏ —Ç—û–ª–¥–∏—Ä–∏–Ω–≥.",
        "fullname": "‚ùóÔ∏è–ò–ª—Ç–∏–º–æ—Å, –∏—Å–º –≤–∞ —Ñ–∞–º–∏–ª–∏—è–Ω–≥–∏–∑–Ω–∏ —ë–∑–∏–Ω–≥.",
        "phone_number": "‚ùóÔ∏è–ò–ª—Ç–∏–º–æ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏–Ω–≥–∏–∑–Ω–∏ —ë–∑–∏–Ω–≥ —ë–∫–∏ —Ç—É–≥–º–∞–Ω–∏ –±–æ—Å–∏–Ω–≥.",
        "birthdate": "üìÖ–°–∞–Ω–∞ —ë–∑–∏–Ω–≥ '–ö–ö.–û–û.–ô–ô–ô–ô' —Ñ–æ—Ä–º–∞—Ç–∏–¥–∞.",
        "rules": "üìö–°–∏–∑ –±–æ—Ç “õ–æ–∏–¥–∞–ª–∞—Ä–Ω–∏ —û“õ–∏–º–∞–¥–∏–Ω–≥–∏–∑ –≤–∞ “õ–∞–±—É–ª “õ–∏–ª–º–∞–¥–∏–Ω–≥–∏–∑."
    }
}

invalid_referal = {
    "ru": "‚ùóÔ∏è–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É.",
    "uz": "‚ùóÔ∏èNoto'g'ri referal havolasi parametrlari. Iltimos, havolani tekshiring.",
    "—É–∑": "‚ùóÔ∏è–ù–æ—Ç—û“ì—Ä–∏ —Ä–µ—Ñ–µ—Ä–∞–ª “≥–∞–≤–æ–ª–∞—Å–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–∞—Ä–∏. –ò–ª—Ç–∏–º–æ—Å, “≥–∞–≤–æ–ª–∞–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–Ω–≥."
}

welcome_text = """
üëãüèª–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø - –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–≥–∞–º–∏. –Ø –ø–æ–º–æ–≥—É –≤–∞–º –≤–µ—Å—Ç–∏ —É—á–µ—Ç –¥–æ–ª–≥–æ–≤.
–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, –≤–∞–º –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è. –î–ª—è –Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

===========================================

üëãüèªAssalomu aleykum! Men qarzlar boshqarish uchun botman. Qarzlar hisobini yuritishda yordam beraman.
Ishni boshlash uchun ro'yxatdan o'tishingiz kerak. Boshlash uchun interfeys tilini tanlang."""

registrated_text = {
    "ru": "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.",
    "uz": "Siz allaqachon ro'yxatdan o'tgansiz.",
    "—É–∑": "–°–∏–∑ –∞–ª–ª–∞“õ–∞—á–æ–Ω —Ä—û–π—Ö–∞—Ç–¥–∞–Ω —û—Ç–≥–∞–Ω—Å–∏–∑."
}

invalid_birthdate = {
    "ru": "‚ùóÔ∏è–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
    "uz": "‚ùóÔ∏èNoto'g'ri sana formati. Iltimos, sanani KK.OO.YYYY formatda kiriting",
    "—É–∑": "‚ùóÔ∏è–ù–æ—Ç—û“ì—Ä–∏ —Å–∞–Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∏. –ò–ª—Ç–∏–º–æ—Å, —Å–∞–Ω–∞–Ω–∏ –ö–ö.–û–û.–ô–ô–ô–ô —Ñ–æ—Ä–º–∞—Ç–¥–∞ –∫–∏—Ä–∏—Ç–∏–Ω–≥"
}

invalid_phone = {
    "ru": "‚ùó–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +998XXXXXXXXX",
    "uz": "‚ùóTelefon raqami noto'g'ri kiritildi. Iltimos, telefon raqamini +998XXXXXXXXX formatda kiriting",
    "oz": "‚ùó–¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏ –Ω–æ—Ç—û“ì—Ä–∏ –∫–∏—Ä–∏—Ç–∏–ª–¥–∏. –ò–ª—Ç–∏–º–æ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏–Ω–∏ +998XXXXXXXXX —Ñ–æ—Ä–º–∞—Ç–¥–∞ –∫–∏—Ä–∏—Ç–∏–Ω–≥"
}

invalid_creditor = {
    "ru": "‚ùó–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ –¥–æ–ª–∂–Ω–∏–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–æ–ª–∂–Ω–∏–∫–∞.",
    "uz": "‚ùóQarzdor ismi noto'g'ri formatda. Iltimos, qarzdor ismini kiriting.",
    "oz": "‚ùó“ö–∞—Ä–∑–¥–æ—Ä –∏—Å–º–∏ –Ω–æ—Ç—û“ì—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–¥–∞. –ò–ª—Ç–∏–º–æ—Å, “õ–∞—Ä–∑–¥–æ—Ä –∏—Å–º–∏–Ω–∏ –∫–∏—Ä–∏—Ç–∏–Ω–≥."
}

invalid_d_p_format = {
    "ru": "‚ùó–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–æ–ª–∂–Ω–∏–∫–∞ –∏ –µ–≥–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–ò–º—è - +998XXXXXXXXX'",
    "uz": "‚ùóNoto'g'ri kiritish formati. Iltimos, qarzdor ismini va uning telefon raqamini 'Ism - +998XXXXXXXXX' formatda kiriting",
    "oz": "‚ùó–ù–æ—Ç—û“ì—Ä–∏ –∫–∏—Ä–∏—Ç–∏—à —Ñ–æ—Ä–º–∞—Ç–∏. –ò–ª—Ç–∏–º–æ—Å, “õ–∞—Ä–∑–¥–æ—Ä –∏—Å–º–∏–Ω–∏ –≤–∞ —É–Ω–∏–Ω–≥ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏–Ω–∏ '–ò—Å–º - +998XXXXXXXXX' —Ñ–æ—Ä–º–∞—Ç–¥–∞ –∫–∏—Ä–∏—Ç–∏–Ω–≥"
}

invalid_amount = {
    "ru": "‚ùó–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–æ–ª–≥–∞.",
    "uz": "‚ùóNoto'g'ri kiritish formati. Iltimos, qarz summasini kiriting.",
    "oz": "‚ùó–ù–æ—Ç—û“ì—Ä–∏ –∫–∏—Ä–∏—Ç–∏—à —Ñ–æ—Ä–º–∞—Ç–∏. –ò–ª—Ç–∏–º–æ—Å, “õ–∞—Ä–∑ —Å—É–º–º–∞—Å–∏–Ω–∏ –∫–∏—Ä–∏—Ç–∏–Ω–≥."
}

invalid_date = {
    "ru": "‚ùó–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
    "uz": "‚ùóNoto'g'ri sana formati. Iltimos, sanani KK.OO.YYYY formatda kiriting",
    "oz": "‚ùó–ù–æ—Ç—û“ì—Ä–∏ —Å–∞–Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∏. –ò–ª—Ç–∏–º–æ—Å, —Å–∞–Ω–∞–Ω–∏ –ö–ö.–û–û.–ô–ô–ô–ô —Ñ–æ—Ä–º–∞—Ç–¥–∞ –∫–∏—Ä–∏—Ç–∏–Ω–≥"
}

rules_text = {
    "ru": "üìö–ü—Ä–∞–≤–∏–ª–∞",
    "uz": "üìöQoidalar",
    "oz": "üìö“ö–æ–∏–¥–∞–ª–∞—Ä"
}
rules_links = {
    "ru": "https://telegra.ph/Pravila-zajma-11-20",
    "uz": "https://telegra.ph/Qarz-oldi-berdi-munosabatlari-uchun-eslatma-11-20",
    "oz": "https://telegra.ph/%D2%9Aarz-oldi-berdi-%D2%9Boidalari-11-20"
}
accept_text = {
    "ru": "‚òëÔ∏è–ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞",
    "uz": "‚òëÔ∏èQoidalar qabul qilish",
    "oz": "‚òëÔ∏è“ö–æ–∏–¥–∞–ª–∞—Ä–Ω–∏ “õ–∞–±—É–ª “õ–∏–ª–∏—à"
}

registration_complete = {
    "ru": "üéâ–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
    "uz": "üéâRo'yxatdan o'tish yakunlandi!",
    "oz": "üéâ–†—û–π—Ö–∞—Ç–¥–∞–Ω —û—Ç–∏—à —è–∫—É–Ω–ª–∞–Ω–¥–∏!"
}

next_page_text = {
    "ru": "–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞‚û°Ô∏è",
    "uz": "Keyingi sahifa‚û°Ô∏è",
    "oz": "–ö–µ–π–∏–Ω–≥–∏ —Å–∞“≥–∏—Ñ–∞‚û°Ô∏è"
}

previous_page_text = {
    "ru": "‚¨ÖÔ∏è–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
    "uz": "‚¨ÖÔ∏èOldingi sahifa",
    "oz": "‚¨ÖÔ∏è–û–ª–¥–∏–Ω–≥–∏ —Å–∞“≥–∏—Ñ–∞"
}

skip_text = {
    "ru": "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å‚û°Ô∏è",
    "uz": "O'tkazib yuborish‚û°Ô∏è",
    "oz": "–é—Ç–∫–∞–∑–∏–± —é–±–æ—Ä–∏—à‚û°Ô∏è"
}

end_text = {
    "ru": "‚úã–ó–∞–≤–µ—Ä—à–∏—Ç—å",
    "uz": "‚úãYakunlash",
    "oz": "‚úã–Ø–∫—É–Ω–ª–∞—à"
}

debt_404 = {
    "ru": "‚ùóÔ∏è–î–æ–ª–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
    "uz": "‚ùóÔ∏èQarz topilmadi.",
    "oz": "‚ùóÔ∏è“ö–∞—Ä–∑ —Ç–æ–ø–∏–ª–º–∞–¥–∏."
}

back_text = {
    "ru": "üîô –ù–∞–∑–∞–¥",
    "uz": "üîô Orqaga",
    "oz": "üîô –û—Ä“õ–∞–≥–∞"
}

currency_parse = {
    "uzs": {
        "ru": "—Å—É–º",
        "uz": "so'm",
        "oz": "—Å—û–º",
        "symbol": "UZS"
    },
    "usd": {
        "ru": "–¥–æ–ª–ª–∞—Ä",
        "uz": "dollar",
        "oz": "–¥–æ–ª–ª–∞—Ä",
        "symbol": "$"
    },
    "rub": {
        "ru": "—Ä—É–±–ª—å",
        "uz": "rubl",
        "oz": "—Ä—É–±–ª—å",
        "symbol": "‚ÇΩ"
    },
    "eur": {
        "ru": "–µ–≤—Ä–æ",
        "uz": "yevro",
        "oz": "–µ–≤—Ä–æ",
        "symbol": "‚Ç¨"
    },
}

status_parse = {
    "active": {
        "ru": {
            "full": "üü° –ù–µ –∑–∞–∫—Ä—ã—Ç—ã–π –¥–æ–ª–≥",
            "short": "üü°"
        },
        "uz": {
            "full": "üü° –¢—û–ª–∞–Ω–º–∞–≥–∞–Ω “õ–∞—Ä–∑",
            "short": "üü°"
        },
        "oz": {
            "full": "üü° To'lanmagan qarz",
            "short": "üü°"
        }
    },
    "closed": {
        "ru": {
            "full": "üü¢ –ó–∞–∫—Ä—ã—Ç—ã–π –¥–æ–ª–≥",
            "short": "üü¢"
        },
        "uz": {
            "full": "üü¢ –¢—û–ª–∞–Ω–≥–∞–Ω “õ–∞—Ä–∑",
            "short": "üü¢"
        },
        "oz": {
            "full": "üü¢ To'langan qarz",
            "short": "üü¢"
        }
    },
    "overdue": {
        "ru": {
            "full": "üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –¥–æ–ª–≥",
            "short": "üî¥"
        },
        "uz": {
            "full": "üî¥ Muddati o'tgan qarz",
            "short": "üî¥"
        },
        "oz": {
            "full": "üî¥ –ú—É–¥–¥–∞—Ç–∏ —û—Ç–≥–∞–Ω “õ–∞—Ä–∑",
            "short": "üî¥"
        }
    },
    "draft": {
        "ru": {
            "full": "üü† –ß–µ—Ä–Ω–æ–≤–∏–∫",
            "short": "üü†"
        },
        "uz": {
            "full": "üü† Qoralama",
            "short": "üü†"
        },
        "oz": {
            "full": "üü† Qoralama",
            "short": "üü†"
        }
    }
}

no_comment = {
    "ru": "–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è",
    "uz": "Izohsiz",
    "oz": "–ò–∑–æ“≥—Å–∏–∑"
}

async def borrower_debt_text(debt):
    # Parse `due_date` and `amounts` if they are strings
    try:
        due_dates = json.loads(debt['due_date']) if isinstance(debt['due_date'], str) else debt['due_date']
        amounts = json.loads(debt['amounts']) if isinstance(debt['amounts'], str) else debt['amounts']
    except json.JSONDecodeError:
        raise ValueError("Failed to parse due dates or amounts as JSON.")

    # Ensure lengths of `due_dates` and `amounts` match
    if not isinstance(due_dates, list) or not isinstance(amounts, list):
        raise ValueError("due_date and amounts must be qarz_lists.")
    if len(due_dates) != len(amounts):
        raise ValueError("Mismatch between number of due dates and amounts.")

    # Format due dates and amounts into text
    due_date_texts = [
        f"{date} - {amount} {currency_parse[debt['currency']]['symbol']}"
        for date, amount in zip(due_dates, amounts)
    ]
    due_dates_display = "\n".join([f"{i + 1}. {item}" for i, item in enumerate(due_date_texts)])

    borrower = await get_user_by_id(debt['borrower_id'])

    return {
        "ru": (
            f"–û—Ç –í–∞—Å —Ö–æ—Ç—è—Ç –≤–∑—è—Ç—å –¥–æ–ª–≥.\nüìë –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–ª–≥–µ:\n\n"
            f"üë§–ò–º—è –∑–∞—ë–º—â–∏–∫–∞: {debt['draft_name']}\n"
            f"üìû–ù–æ–º–µ—Ä –∑–∞—ë–º—â–∏–∫–∞: {debt['draft_phone']}\n"
            f"üë§–ò–º—è –¥–æ–ª–∂–Ω–∏–∫–∞: {borrower['fullname']}\n"
            f"üìû–ù–æ–º–µ—Ä –¥–æ–ª–∂–Ω–∏–∫–∞: {borrower['phone_number']}\n"
            f"üí∏–°—É–º–º–∞ –¥–æ–ª–≥–∞: {debt['full_amount']} {currency_parse[debt['currency']]['ru']}\n"
            f"üìÖ–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–ª–≥–∞: {debt['loan_date']}\n"
            f"üìÖ–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:\n{due_dates_display}\n"
            f"üí¨–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {debt['comment'] if debt['comment'] else '–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}\n\n"
            f"üìù–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."
        ),
        "uz": (
            f"Sizdan qarz so'rayapti.\nüìëQarz haqida ma'lumot:\n\n"
            f"üë§Qarz oluvchi ismi: {debt['draft_name']}\n"
            f"üìûQarz oluvchi raqami: {debt['draft_phone']}\n"
            f"üë§Qarzdor ismi: {borrower['fullname']}\n"
            f"üìûQarzdor raqami: {borrower['phone_number']}\n"
            f"üí∏Qarz summasi: {debt['full_amount']} {currency_parse[debt['currency']]['uz']}\n"
            f"üìÖQarz olish sanasi: {debt['loan_date']}\n"
            f"üìÖTo'lovlar jadvali:\n{due_dates_display}\n"
            f"üí¨Izoh: {debt['comment'] if debt['comment'] else 'izohsiz'}\n\n"
            f"üìùSo'rovni qabul yoki rad etish uchun pastdagi tugmani bosing."
        ),
        "oz": (
            f"–°–∏–∑–¥–∞–Ω “õ–∞—Ä–∑ —Å—û—Ä–∞–π–∞–ø—Ç–∏.\nüìë“ö–∞—Ä–∑ “≥–∞“õ–∏–¥–∞ –º–∞—ä–ª—É–º–æ—Ç:\n\n"
            f"üë§–ò—Å–º –æ–ª—É–≤—á–∏: {debt['draft_name']}\n"
            f"üìû–¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {debt['draft_phone']}\n"
            f"üë§–ë–æ—Ä—á–∏ –∏—Å–º–∏: {borrower['fullname']}\n"
            f"üìû–ë–æ—Ä—á–∏ —Ä–∞“õ–∞–º–∏: {borrower['phone_number']}\n"
            f"üí∏“ö–∞—Ä–∑ —Å—É–º–º–∞—Å–∏: {debt['full_amount']} {currency_parse[debt['currency']]['oz']}\n"
            f"üìÖ“ö–∞—Ä–∑ –æ–ª–∏—à —Å–∞–Ω–∞—Å–∏: {debt['loan_date']}\n"
            f"üìÖ–¢—û–ª–æ–≤–ª–∞—Ä –∂–∞–¥–≤–∞–ª–∏:\n{due_dates_display}\n"
            f"üí¨–ò–∑–æ“≥: {debt['comment'] if debt['comment'] else '–∏–∑–æ“≥—Å–∏–∑'}\n\n"
            f"üìù–°—û—Ä–æ–≤–Ω–∏ “õ–∞–±—É–ª —ë–∫–∏ —Ä–∞–¥ —ç—Ç–∏—à —É—á—É–Ω —Ç—É–≥–º–∞–Ω–∏ –±–æ—Å–∏–Ω–≥."
        )
    }

async def debtor_debt_text(debt, user):
    """Generate debt confirmation text for the debtor."""
    try:
        # Safely parse due_date and amounts
        due_dates = json.loads(debt['due_date']) if isinstance(debt['due_date'], str) else debt['due_date'] or []
        amounts = json.loads(debt['amounts']) if isinstance(debt['amounts'], str) else debt['amounts'] or []
    except json.JSONDecodeError:
        raise ValueError("Failed to parse due dates or amounts as JSON.")

    if not isinstance(due_dates, list) or not isinstance(amounts, list):
        raise ValueError("due_date and amounts must be qarz_lists.")
    if len(due_dates) != len(amounts):
        raise ValueError("Mismatch between number of due dates and amounts.")

    # Format due dates and amounts
    due_date_texts = [
        f"{date} - {amount} {currency_parse[debt['currency']]['symbol']}"
        for date, amount in zip(due_dates, amounts)
    ]
    due_dates_display = "\n".join([f"{i + 1}. {item}" for i, item in enumerate(due_date_texts)])

    debtor = await get_user_by_id(debt['debtor_id'])
    if not debtor:
        raise ValueError("Debtor not found.")  # Ensure debtor exists

    return {
        "ru": (
            f"–í—ã —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å –¥–æ–ª–≥.\nüìë –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–ª–≥–µ:\n\n"
            f"üë§–ò–º—è –∑–∞—ë–º—â–∏–∫–∞: {user['fullname']}\n"
            f"üìû–ù–æ–º–µ—Ä –∑–∞—ë–º—â–∏–∫–∞: {user['phone_number']}\n"
            f"üë§–ò–º—è –¥–æ–ª–∂–Ω–∏–∫–∞: {debtor['fullname']}\n"
            f"üìû–ù–æ–º–µ—Ä –¥–æ–ª–∂–Ω–∏–∫–∞: {debtor['phone_number']}\n"
            f"üí∏–°—É–º–º–∞ –¥–æ–ª–≥–∞: {debt['full_amount']} {currency_parse[debt['currency']]['ru']}\n"
            f"üìÖ–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ª–≥–∞: {debt['loan_date']}\n"
            f"üìÖ–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:\n{due_dates_display}\n"
            f"üí¨–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {debt['comment'] if debt['comment'] else '–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}\n\n"
            f"üìù–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."
        ),
        "uz": (
            f"Siz qarz olmoqchisiz.\nüìëQarz haqida ma'lumot:\n\n"
            f"üë§Qarz beruvchi ismi: {user['fullname']}\n"
            f"üìûQarz beruvchi raqami: {user['phone_number']}\n"
            f"üë§Qarzdor ismi: {debtor['fullname']}\n"
            f"üìûQarzdor raqami: {debtor['phone_number']}\n"
            f"üí∏Qarz summasi: {debt['full_amount']} {currency_parse[debt['currency']]['uz']}\n"
            f"üìÖQarz olish sanasi: {debt['loan_date']}\n"
            f"üìÖTo'lovlar jadvali:\n{due_dates_display}\n"
            f"üí¨Izoh: {debt['comment'] if debt['comment'] else 'izohsiz'}\n\n"
            f"üìùSo'rovni qabul yoki rad etish uchun pastdagi tugmani bosing."
        ),
        "oz": (
            f"–°–∏–∑ “õ–∞—Ä–∑ –æ–ª–º–æ“õ—á–∏—Å–∏–∑.\nüìë“ö–∞—Ä–∑ “≥–∞“õ–∏–¥–∞ –º–∞—ä–ª—É–º–æ—Ç:\n\n"
            f"üë§“ö–∞—Ä–∑ –±–µ—Ä—É–≤—á–∏ –∏—Å–º–∏: {user['fullname']}\n"
            f"üìû“ö–∞—Ä–∑ –±–µ—Ä—É–≤—á–∏ —Ä–∞“õ–∞–º–∏: {user['phone_number']}\n"
            f"üë§“ö–∞—Ä–∑–¥–æ—Ä –∏—Å–º–∏: {debtor['fullname']}\n"
            f"üìû“ö–∞—Ä–∑–¥–æ—Ä —Ä–∞“õ–∞–º–∏: {debtor['phone_number']}\n"
            f"üí∏“ö–∞—Ä–∑ —Å—É–º–º–∞—Å–∏: {debt['full_amount']} {currency_parse[debt['currency']]['oz']}\n"
            f"üìÖ“ö–∞—Ä–∑ –æ–ª–∏—à —Å–∞–Ω–∞—Å–∏: {debt['loan_date']}\n"
            f"üìÖ–¢—û–ª–æ–≤–ª–∞—Ä –∂–∞–¥–≤–∞–ª–∏:\n{due_dates_display}\n"
            f"üí¨–ò–∑–æ“≥: {debt['comment'] if debt['comment'] else '–∏–∑–æ“≥—Å–∏–∑'}\n\n"
            f"üìù–°—û—Ä–æ–≤–Ω–∏ “õ–∞–±—É–ª —ë–∫–∏ —Ä–∞–¥ —ç—Ç–∏—à —É—á—É–Ω —Ç—É–≥–º–∞–Ω–∏ –±–æ—Å–∏–Ω–≥."
        )
    }


def creation_getdebt_text(user, data, comment=""):
    creditor_name = data.get("getdebt_creditor")
    creditor_phone_number = data.get("getdebt_creditor_phone")
    amount = int(data.get("getdebt_amount"))
    currency = data.get("getdebt_currency")
    loan_date = datetime.strptime(data.get("getdebt_loan_date"), "%d.%m.%Y")

    # Parse due dates and divided amounts
    due_dates = [
        datetime.strptime(item["due_date"], "%d.%m.%Y").strftime("%d.%m.%Y")
        for item in data.get("getdebt_due_date", [])
    ]
    divided_amounts = [
        int(item["divided_amount"])
        for item in data.get("getdebt_amounts", [])
    ]

    # Ensure due_dates and divided_amounts have the same length
    if len(due_dates) != len(divided_amounts):
        raise ValueError("Mismatch between due dates and divided amounts.")

    # Combine due dates and amounts into a formatted string
    payment_schedule = "\n".join(
        f"{i + 1}. {due_date} - {amount} {currency}"
        for i, (due_date, amount) in enumerate(zip(due_dates, divided_amounts))
    )

    return {
        "ru": (
            f"‚òëÔ∏è–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –∏–ª–∏ –≤—ã–±–µ—Ä–µ–º –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ –Ω–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —ç—Ç–æ—Ç –¥–æ–ª–≥ –∏ –≤—Å—ë –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n\n"
            f"üìë–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ –¥–æ–ª–≥:\n"
            f"üë§ –ó–∞—ë–º—â–∏–∫: {creditor_name}\n"
            f"üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∑–∞—ë–º—â–∏–∫–∞: {creditor_phone_number}\n"
            f"üë§ –î–æ–ª–∂–Ω–∏–∫: {user['fullname']}\n"
            f"üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–Ω–∏–∫–∞: {user['phone_number']}\n"
            f"üí∞ –°—É–º–º–∞: {amount} {currency_parse[currency]['ru']}\n"
            f"üìÖ –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏: {loan_date.strftime('%d.%m.%Y')}\n"
            f"üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:\n{payment_schedule}\n"
            f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment if comment else '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}\n\n"
            f"üìù–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."
        ),
        "uz": (
            f"‚òëÔ∏èAjoyib! Keling, ushbu qarzni tasdiqlash va hamma narsa rasmiy bo'lishi uchun qarz beruvchiga havolani yuboramiz yoki ro'yxatimizdan u odamni tanlaymiz.\n\n"
            f"üìëQarz haqida ma'lumot:\n"
            f"üë§ Qarz beruvchi: {creditor_name}\n"
            f"üìû Telefon raqami: {creditor_phone_number}\n"
            f"üë§ Qarz oluvchi: {user['fullname']}\n"
            f"üìû Telefon raqami: {user['phone_number']}\n"
            f"üí∞ Summa: {amount} {currency_parse[currency]['uz']}\n"
            f"üìÖ Qarz berilgan sana: {loan_date.strftime('%d.%m.%Y')}\n"
            f"üìÖ To'lovlar jadvali:\n{payment_schedule}\n"
            f"üí¨ Izoh: {comment if comment else 'Izohsiz'}\n\n"
            f"üìùSo'rovni qabul yoki rad etish uchun pastdagi tugmani bosing."
        ),
        "oz": (
            f"‚òëÔ∏è–ê–∂–æ–π–∏–±! –ö–µ–ª–∏–Ω–≥, —É—à–±—É “õ–∞—Ä–∑–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞—à –≤–∞ “≥–∞–º–º–∞ –Ω–∞—Ä—Å–∞ —Ä–∞—Å–º–∏–π –±—û–ª–∏—à–∏ —É—á—É–Ω “õ–∞—Ä–∑ –±–µ—Ä—É–≤—á–≥–∞ “≥–∞–≤–æ–ª–∞–Ω–∏ —é–±–æ—Ä–∞–º–∏–∑ —ë–∫–∏ —Ä—û–π—Ö–∞—Ç–∏–º–∏–∑–¥–∞–Ω —É –æ–¥–∞–º–Ω–∏ —Ç–∞–Ω–ª–∞–π–º–∏–∑.\n\n"
            f"üìë“ö–∞—Ä–∑ “≥–∞“õ–∏–¥–∞ –º–∞—ä–ª—É–º–æ—Ç:\n"
            f"üë§ “ö–∞—Ä–∑ –±–µ—Ä—É–≤—á–∏: {creditor_name}\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {creditor_phone_number}\n"
            f"üë§ “ö–∞—Ä–∑ –æ–ª—É–≤—á–∏: {user['fullname']}\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {user['phone_number']}\n"
            f"üí∞ –°—É–º–º–∞: {amount} {currency_parse[currency]['oz']}\n"
            f"üìÖ “ö–∞—Ä–∑ –±–µ—Ä–∏–ª–≥–∞–Ω —Å–∞–Ω–∞: {loan_date.strftime('%d.%m.%Y')}\n"
            f"üìÖ –¢—û–ª–æ–≤–ª–∞—Ä –∂–∞–¥–≤–∞–ª–∏:\n{payment_schedule}\n"
            f"üí¨ –ò–∑–æ“≥: {comment if comment else '–ò–∑–æ“≥—Å–∏–∑'}\n\n"
            f"üìù–°—û—Ä–æ–≤–Ω–∏ “õ–∞–±—É–ª —ë–∫–∏ —Ä–∞–¥ —ç—Ç–∏—à —É—á—É–Ω –ø–∞—Å—Ç–¥–∞–≥–∏ —Ç—É–≥–º–∞–Ω–∏ –±–æ—Å–∏–Ω–≥."
        )
    }

def creation_givedebt_text(user, data, comment=""):
    creditor_name = data.get("givedebt_debtor")
    creditor_phone_number = data.get("givedebt_debtor_phone")
    amount = int(data.get("givedebt_amount"))
    currency = data.get("givedebt_currency")
    loan_date = datetime.strptime(data.get("givedebt_loan_date"), "%d.%m.%Y")

    # Parse due dates and divided amounts
    due_dates = [
        datetime.strptime(item["due_date"], "%d.%m.%Y").strftime("%d.%m.%Y")
        for item in data.get("givedebt_due_date", [])
    ]
    divided_amounts = [
        int(item["divided_amount"])
        for item in data.get("givedebt_amounts", [])
    ]

    # Ensure due_dates and divided_amounts have the same length
    if len(due_dates) != len(divided_amounts):
        raise ValueError("Mismatch between due dates and divided amounts.")

    # Combine due dates and amounts into a formatted string
    payment_schedule = "\n".join(
        f"{i + 1}. {due_date} - {amount} {currency}"
        for i, (due_date, amount) in enumerate(zip(due_dates, divided_amounts))
    )

    return {
        "ru": (
            f"‚òëÔ∏è–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –∏–ª–∏ –≤—ã–±–µ—Ä–µ–º –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ –Ω–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —ç—Ç–æ—Ç –¥–æ–ª–≥ –∏ –≤—Å—ë –±—ã–ª–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ.\n\n"
            f"üìë–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ –¥–æ–ª–≥:\n"
            f"üë§ –ó–∞—ë–º—â–∏–∫: {user['fullname']}\n"
            f"üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∑–∞—ë–º—â–∏–∫–∞: {user['phone_number']}\n"
            f"üë§ –î–æ–ª–∂–Ω–∏–∫: {creditor_name}\n"
            f"üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–Ω–∏–∫–∞: {creditor_phone_number}\n"
            f"üí∞ –°—É–º–º–∞: {amount} {currency_parse[currency]['ru']}\n"
            f"üìÖ –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏: {loan_date.strftime('%d.%m.%Y')}\n"
            f"üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:\n{payment_schedule}\n"
            f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment if comment else '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}\n\n"
            f"üìù–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."
        ),
        "uz": (
            f"‚òëÔ∏èAjoyib! Keling, ushbu qarzni tasdiqlash va hamma narsa rasmiy bo'lishi uchun qarz beruvchiga havolani yuboramiz yoki ro'yxatimizdan u odamni tanlaymiz.\n\n"
            f"üìëQarz haqida ma'lumot:\n"
            f"üë§ Qarz beruvchi: {user['fullname']}\n"
            f"üìû Telefon raqami: {user['phone_number']}\n"
            f"üë§ Qarz oluvchi: {creditor_name}\n"
            f"üìû Telefon raqami: {creditor_phone_number}\n"
            f"üí∞ Summa: {amount} {currency_parse[currency]['uz']}\n"
            f"üìÖ Qarz berilgan sana: {loan_date.strftime('%d.%m.%Y')}\n"
            f"üìÖ To'lovlar jadvali:\n{payment_schedule}\n"
            f"üí¨ Izoh: {comment if comment else 'Izohsiz'}\n\n"
            f"üìùSo'rovni qabul yoki rad etish uchun pastdagi tugmani bosing."
        ),
        "oz": (
            f"‚òëÔ∏è–ê–∂–æ–π–∏–±! –ö–µ–ª–∏–Ω–≥, —É—à–±—É “õ–∞—Ä–∑–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞—à –≤–∞ “≥–∞–º–º–∞ –Ω–∞—Ä—Å–∞ —Ä–∞—Å–º–∏–π –±—û–ª–∏—à–∏ —É—á—É–Ω “õ–∞—Ä–∑ –±–µ—Ä—É–≤—á–≥–∞ “≥–∞–≤–æ–ª–∞–Ω–∏ —é–±–æ—Ä–∞–º–∏–∑ —ë–∫–∏ —Ä—û–π—Ö–∞—Ç–∏–º–∏–∑–¥–∞–Ω —É –æ–¥–∞–º–Ω–∏ —Ç–∞–Ω–ª–∞–π–º–∏–∑.\n\n"
            f"üìë“ö–∞—Ä–∑ “≥–∞“õ–∏–¥–∞ –º–∞—ä–ª—É–º–æ—Ç:\n"
            f"üë§ “ö–∞—Ä–∑ –±–µ—Ä—É–≤—á–∏: {user['fullname']}\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {user['phone_number']}\n"
            f"üë§ “ö–∞—Ä–∑ –æ–ª—É–≤—á–∏: {creditor_name}\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {creditor_phone_number}\n"
            f"üí∞ –°—É–º–º–∞: {amount} {currency_parse[currency]['oz']}\n"
            f"üìÖ “ö–∞—Ä–∑ –±–µ—Ä–∏–ª–≥–∞–Ω —Å–∞–Ω–∞: {loan_date.strftime('%d.%m.%Y')}\n"
            f"üìÖ –¢—û–ª–æ–≤–ª–∞—Ä –∂–∞–¥–≤–∞–ª–∏:\n{payment_schedule}\n"
            f"üí¨ –ò–∑–æ“≥: {comment if comment else '–ò–∑–æ“≥—Å–∏–∑'}\n\n"
            f"üìù–°—û—Ä–æ–≤–Ω–∏ “õ–∞–±—É–ª —ë–∫–∏ —Ä–∞–¥ —ç—Ç–∏—à —É—á—É–Ω –ø–∞—Å—Ç–¥–∞–≥–∏ —Ç—É–≥–º–∞–Ω–∏ –±–æ—Å–∏–Ω–≥."
        )
    }

accept_text = {
    "ru": "‚òëÔ∏è–ü—Ä–∏–Ω—è—Ç—å",
    "uz": "‚òëÔ∏èQabul qilish",
    "oz": "‚òëÔ∏è“ö–∞–±—É–ª “õ–∏–ª–∏—à"
}

reject_text = {
    "ru": "‚ùå–û—Ç–∫–ª–æ–Ω–∏—Ç—å",
    "uz": "‚ùåRad etish",
    "oz": "‚ùå–†–∞–¥ —ç—Ç–∏—à"
}

emoji_explanation = {
    "uz": (
        "‚úÖ - Miqdor to'liq to'langan\n"
        "‚ùå - Miqdor to'liq to'lanmagan"
    ),
    "ru": (
        "‚úÖ - –°—É–º–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω–∞\n"
        "‚ùå - –°—É–º–º–∞ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é"
    ),
    "oz": (
        "‚úÖ - –ú–∏“õ–¥–æ—Ä —Ç—û–ª–∏“õ —Ç—û–ª–∞–Ω–≥–∞–Ω\n"
        "‚ùå - –ú–∏“õ–¥–æ—Ä —Ç—û–ª–∏“õ —Ç—û–ª–∞–Ω–º–∞–≥–∞–Ω"
    )
}

import json
from datetime import datetime

async def debt_text(debt):
    # Fetching user information
    debtor = await get_user_by_id(debt['debtor_id'])
    borrower = await get_user_by_id(debt['borrower_id'])

    # Get currency symbol
    currency = currency_parse[debt['currency']]['symbol']

    due_dates = json.loads(debt['due_date'])
    divided_amounts = json.loads(debt['amounts'])
    paid_amounts = json.loads(qarz_debt.get('paid_amount', "{}"))  # Default to empty dict if None

    # Calculate the paid amounts applied to each installment
    remaining_amounts = divided_amounts[:]
    total_paid = sum(paid_amounts.values())
    paid_per_date = {}

    for date, paid in paid_amounts.items():
        paid_per_date[date] = paid

    # Deduct payments from each divided amount
    for i, amount in enumerate(divided_amounts):
        for date, paid in paid_per_date.items():
            if paid <= 0:
                continue
            if amount <= paid:
                remaining_amounts[i] = 0
                paid_per_date[date] -= amount
                break
            else:
                remaining_amounts[i] -= paid
                paid_per_date[date] = 0

    # Build the payment schedule
    payment_schedule = "\n".join(
        f"{i + 1}. {due_date} - {amount} {currency} " +
        (f"‚úÖ" if remaining_amounts[i] == 0 else f"‚ùå (qolgan miqdor: {remaining_amounts[i]} {currency})")
        for i, (due_date, amount) in enumerate(zip(due_dates, divided_amounts))
    )

    # Return the formatted debt info
    return {
        "uz": (
            f"üìë Qarz haqida ma'lumot:\n\n"
            f"üë§ Qarz beruvchi: {debtor['fullname']}\n"
            f"üìû Qarz beruvchi telefon raqami: {debtor['phone_number']}\n"
            f"üë§ Qarzdor: {borrower['fullname']}\n"
            f"üìû Qarzdor telefon raqami: {borrower['phone_number']}\n"
            f"üí∞ Qarz miqdori: {debt['full_amount']} {currency}\n"
            f"üìÖ Qarz berilgan kun: {debt['loan_date'].strftime('%d.%m.%Y')}\n"
            f"üìÖ Qarz berish jadvali:\n{payment_schedule}\n\n"
            f"{emoji_explanation['uz']}\n\n"
            f"üí¨ Izoh: {qarz_debt.get('comment') if qarz_debt.get('comment') else 'Izoh qoldirilmagan'}"
        ),
        "ru": (
            f"üìë –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–ª–≥–µ:\n\n"
            f"üë§ –ó–∞—ë–º—â–∏–∫: {debtor['fullname']}\n"
            f"üìû –ù–æ–º–µ—Ä –∑–∞—ë–º—â–∏–∫–∞: {debtor['phone_number']}\n"
            f"üë§ –î–æ–ª–∂–Ω–∏–∫: {borrower['fullname']}\n"
            f"üìû –ù–æ–º–µ—Ä –¥–æ–ª–∂–Ω–∏–∫–∞: {borrower['phone_number']}\n"
            f"üí∞ –°—É–º–º–∞ –¥–æ–ª–≥–∞: {debt['full_amount']} {currency}\n"
            f"üìÖ –î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ª–≥–∞: {debt['loan_date'].strftime('%d.%m.%Y')}\n"
            f"üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:\n{payment_schedule}\n\n"
            f"{emoji_explanation['ru']}\n\n"
            f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {qarz_debt.get('comment') if qarz_debt.get('comment') else '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –æ—Å—Ç–∞–≤–ª–µ–Ω'}"
        ),
        "oz": (
            f"üìë “ö–∞—Ä–∑ “≥–∞“õ–∏–¥–∞ –º–∞—ä–ª—É–º–æ—Ç:\n\n"
            f"üë§ “ö–∞—Ä–∑ –±–µ—Ä—É–≤—á–∏: {debtor['fullname']}\n"
            f"üìû “ö–∞—Ä–∑ –±–µ—Ä—É–≤—á–∏ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {debtor['phone_number']}\n"
            f"üë§ “ö–∞—Ä–∑–¥–æ—Ä: {borrower['fullname']}\n"
            f"üìû “ö–∞—Ä–∑–¥–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {borrower['phone_number']}\n"
            f"üí∞ “ö–∞—Ä–∑ –º–∏“õ–¥–æ—Ä–∏: {debt['full_amount']} {currency}\n"
            f"üìÖ “ö–∞—Ä–∑ –±–µ—Ä–∏–ª–≥–∞–Ω –∫—É–Ω: {debt['loan_date'].strftime('%d.%m.%Y')}\n"
            f"üìÖ “ö–∞—Ä–∑ –±–µ—Ä–∏—à –∂–∞–¥–≤–∞–ª–∏:\n{payment_schedule}\n\n"
            f"{emoji_explanation['oz']}\n\n"
            f"üí¨ –ò–∑–æ“≥: {qarz_debt.get('comment') if qarz_debt.get('comment') else '–ò–∑–æ“≥ –∫—û–ª–¥–∏—Ä–∏–ª–º–∞–≥–∞–Ω'}"
        )
    }

amount_entered_successfully = {
    "ru": "‚úÖ –°—É–º–º–∞ —É—Å–ø–µ—à–Ω–æ –≤–≤–µ–¥–µ–Ω–∞.",
    "uz": "‚úÖ Summa muvaffaqiyatli kiritildi.",
    "oz": "‚úÖ –°—É–º–º–∞ –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ –∫–∏—Ä–∏—Ç–∏–ª–¥–∏."
}

enter_valid_amount = {
    "ru": "‚ùóÔ∏è–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.",
    "uz": "‚ùóÔ∏èTo'g'ri summani kiriting.",
    "oz": "‚ùóÔ∏è–¢—û“ì—Ä–∏ —Å—É–º–º–∞–Ω–∏ –∫–∏—Ä–∏—Ç–∏–Ω–≥."
}

def debt_completed(debt_id) -> str:
    return {
        "ru": f"‚úÖ –î–æ–ª–≥ \"{debt_id}\" —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.",
        "uz": f"‚úÖ \"{debt_id}\" Qarz muvaffaqiyatli yakunlandi.",
        "oz": f"‚úÖ \"{debt_id}\" “ö–∞—Ä–∑ –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ —è–∫—É–Ω–ª–∞–Ω–¥–∏."
    }

def user_data(user):
    return {
        "ru": (
            f"üë§ –ò–º—è: {user['fullname']}\n"
            f"üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {user['phone_number']}\n"
            f"üéÇ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: {user['birthdate']}\n"
            f"‚öôÔ∏è –Ø–∑—ã–∫: {user['lang']}\n\n"
            f"üìù –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ."
        ),
        "uz": (
            f"üë§ Ism: {user['fullname']}\n"
            f"üìû Telefon raqami: {user['phone_number']}\n"
            f"üéÇ Tug'ilgan kun: {user['birthdate']}\n"
            f"‚öôÔ∏è Til: {user['lang']}\n\n"
            f"üìù Ma'lumotlarni o'zgartirish uchun pastdagi tugmani bosing."
        ),
        "oz": (
            f"üë§ –ò—Å–º: {user['fullname']}\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏: {user['phone_number']}\n"
            f"üéÇ –¢—É“ì–∏–ª–≥–∞–Ω –∫—É–Ω: {user['birthdate']}\n"
            f"‚öôÔ∏è –¢–∏–ª: {user['lang']}\n\n"
            f"üìù –ú–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä–Ω–∏ —û–∑–≥–∞—Ä—Ç–∏—Ä–∏—à —É—á—É–Ω –ø–∞—Å—Ç–¥–∞–≥–∏ —Ç—É–≥–º–∞–Ω–∏ –±–æ—Å–∏–Ω–≥."
        )
    }